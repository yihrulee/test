<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…§åˆ†æ³Œå”èª¿é«˜æ‰‹</title>
    <style>
        /* === å…¨å±€è¨­å®š === */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #263238; color: white; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; height: 100vh; box-sizing: border-box; overflow: hidden; }

        /* === 1. é ‚éƒ¨è³‡è¨Šåˆ— (Score/Time) === */
        .header-bar {
            flex: 0 0 auto; display: flex; justify-content: space-between; width: 95%; max-width: 1200px;
            background: #37474f; padding: 10px 30px; border-radius: 10px; margin-bottom: 10px; 
            border: 1px solid #546e7a; box-shadow: 0 4px 6px rgba(0,0,0,0.3); box-sizing: border-box;
            position: relative;
        }
        .score-val { color: #ffeb3b; font-size: 24px; font-family: monospace; font-weight: 900; }
        .time-val { color: #ff5252; font-size: 24px; font-family: monospace; font-weight: 900; }

        /* === 2. éŠæˆ²ä¸»å®¹å™¨ === */
        .game-container { 
            flex: 1; display: flex; gap: 15px; width: 100%; max-width: 1200px; overflow: hidden; position: relative;
        }

        /* å·¦å´ï¼šæ•¸å€¼ç›£æ§ */
        .status-panel { 
            flex: 0 0 180px; display: flex; flex-direction: column; justify-content: center; gap: 10px; 
            background: #37474f; padding: 10px; border-radius: 10px; overflow-y: auto;
        }
        .status-item { background: #455a64; padding: 5px 8px; border-radius: 8px; border: 1px solid #607d8b; }
        .label { font-weight: bold; font-size: 13px; margin-bottom: 2px; display: block; color: #cfd8dc; }
        .progress-bg { background: #263238; height: 10px; border-radius: 10px; overflow: hidden; border: 1px solid #546e7a; }
        .progress-fill { height: 100%; width: 50%; transition: width 0.2s, background-color 0.2s; }
        .rule-box { margin-top:10px; color:#cfd8dc; text-align:center; font-size:14px; border:1px solid #555; padding:5px; border-radius:5px; }

        /* ä¸­é–“èˆå° */
        .center-stage { 
            flex: 1; background-color: #eceff1; border-radius: 15px; display: flex; flex-direction: column; 
            overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative;
        }

        /* [ä¸Š] äº‹ä»¶å€ */
        .event-section {
            flex: 0 0 90px; background: #fff; border-bottom: 2px solid #ddd;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 5; position: relative; padding: 5px;
        }
        .event-title { font-size: 28px; font-weight: 900; color: #333; margin: 0; }
        .event-desc { font-size: 18px; color: #d84315; margin-top: 2px; font-weight: bold; }
        .timer-bar-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: #ddd; }
        .timer-bar-fill { height: 100%; width: 100%; background: #ff1744; transition: width linear; }

        /* [ä¸­] äººé«”å€ */
        .body-section {
            flex: 1; 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding-top: 20px;
            background: #fafafa; 
            overflow: hidden;
        }
        .body-outline { 
            position: relative; 
            width: 220px; 
            height: 460px; 
            transform-origin: top center; 
            transform: scale(0.9);
        }

        /* äººé«”ç¹ªåœ– CSS */
        .head { width: 65px; height: 75px; background: #ffe0bd; border-radius: 30px; position: absolute; top: 0; left: 78px; border: 3px solid #333; }
        .torso { width: 90px; height: 190px; background: #ffe0bd; border-radius: 15px; position: absolute; top: 80px; left: 65px; border: 3px solid #333; }
        .arm-l { width: 25px; height: 160px; background: #ffe0bd; position: absolute; top: 85px; left: 35px; border-radius: 10px; transform: rotate(12deg); border: 3px solid #333; }
        .arm-r { width: 25px; height: 160px; background: #ffe0bd; position: absolute; top: 85px; left: 160px; border-radius: 10px; transform: rotate(-12deg); border: 3px solid #333; }
        .leg-l { width: 35px; height: 200px; background: #ffe0bd; position: absolute; top: 275px; left: 65px; border-radius: 10px; border: 3px solid #333; }
        .leg-r { width: 35px; height: 200px; background: #ffe0bd; position: absolute; top: 275px; left: 120px; border-radius: 10px; border: 3px solid #333; }

        /* å™¨å®˜æŒ‰éˆ• */
        .gland-btn { position: absolute; width: 45px; height: 45px; background: #ff1744; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 100; font-size: 20px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; transition: transform 0.1s; }
        .gland-btn:hover { transform: scale(1.1); background: #d50000; }
        .gland-btn:active { transform: scale(0.9); }
        #btn-pituitary { top: 15px; left: 88px; background: #aa00ff; } 
        #btn-thyroid { top: 85px; left: 88px; background: #00bcd4; } 
        #btn-parathyroid { top: 85px; left: 125px; width: 25px; height: 25px; background: #ff6d00; font-size: 12px; } 
        #btn-adrenal { top: 165px; left: 75px; background: #f44336; } 
        #btn-pancreas { top: 195px; left: 105px; background: #00c853; } 

        /* [ä¸‹] æ“ä½œé¢æ¿ */
        .control-panel {
            flex: 0 0 90px; background: #263238; border-top: 4px solid #ffeb3b;
            display: flex; justify-content: center; align-items: center; padding: 5px; z-index: 20;
        }
        .placeholder-text { color: #78909c; font-size: 20px; font-weight: bold; }
        .hormone-btn { 
            flex: 1; height: 60px; margin: 0 4px; background: white; color: #333; border: none; border-radius: 8px; 
            cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #999; 
        }
        .hormone-btn:active { transform: translateY(4px); box-shadow: none; }
        .hormone-btn.blue { background: #40c4ff; color: #000; }
        .hormone-btn.green { background: #69f0ae; color: #000; }
        .hormone-btn.orange { background: #ffd740; color: #000; }

        /* ç‰¹æ•ˆèˆ‡ Overlay */
        .score-popup { position: absolute; font-size: 80px; font-weight: 900; color: #ffeb3b; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; z-index: 200; text-shadow: 4px 4px 0 #000; white-space: nowrap; }
        
        /* â˜…â˜…â˜… Overlay ä¿®æ”¹ï¼šåŠ å…¥ overflow-y å…è¨±æ²å‹• â˜…â˜…â˜… */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 10000; flex-direction: column; 
            color: white; text-align: center; 
            padding: 20px; box-sizing: border-box; 
            overflow-y: auto; /* ç•¶å…§å®¹å¤ªé•·æ™‚ï¼Œå…è¨±å‚ç›´æ²å‹• */
        }
        
        .hidden { display: none; }
        .start-btn { padding: 15px 50px; font-size: 30px; background: #ff1744; color: white; border: none; border-radius: 50px; cursor: pointer; margin-top: 20px; font-weight: bold; animation: pulse 1s infinite; }
        
        /* === è¡¨å–®ç›¸é—œ CSS === */
        .upload-form-container { background: #37474f; padding: 20px; border-radius: 15px; border: 2px solid #546e7a; margin-top: 20px; max-width: 300px; width: 100%; display: none; }
        .form-row { margin-bottom: 15px; text-align: left; }
        .form-row label { display: block; color: #cfd8dc; margin-bottom: 5px; font-weight: bold; }
        .form-row input { width: 100%; padding: 10px; border-radius: 5px; border: none; box-sizing: border-box; font-size: 16px; }
        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .action-btn { padding: 15px 30px; font-size: 20px; border: none; border-radius: 40px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-restart { background: #ff1744; }
        .btn-upload { background: #00e676; color: #004d40; }
        .btn-submit { background: #2979ff; width: 100%; margin-top: 10px; }
        .btn-disabled { background: #78909c; cursor: not-allowed; }

        @keyframes floatUp { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); } }
        .score-anim { animation: floatUp 0.8s ease-out forwards; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* èªªæ˜é æ­¥é©Ÿæ¨£å¼ */
        .step-container { display:flex; justify-content:center; gap:15px; margin: 25px 0; flex-wrap: wrap; }
        .step-box { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; width: 120px; border: 1px solid rgba(255,255,255,0.2); }
        .step-icon { font-size: 30px; margin-bottom: 5px; }
        .step-title { font-weight: bold; font-size: 18px; color: #40c4ff; margin-bottom: 5px; }
        .step-desc { font-size: 14px; color: #eceff1; }
        .arrow-icon { font-size: 24px; color: #607d8b; display: flex; align-items: center; }

        /* === 3. é å°¾å°è¦½åˆ— CSS === */
        .footer-nav {
            flex: 0 0 auto; /* ä¸æœƒè¢«å£“ç¸® */
            display: flex; justify-content: space-between; width: 95%; max-width: 1200px;
            padding: 5px 0; margin-top: 5px;
            position: relative;
        }
        .nav-btn {
            padding: 10px 20px; font-size: 18px; border-radius: 8px; text-decoration: none;
            color: white; background: #607d8b; transition: 0.3s; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:hover { background: #78909c; }
        
        .nav-btn.disabled {
            background: #37474f; 
            color: #546e7a; 
            pointer-events: none; 
            cursor: default;
            border: 1px solid #455a64;
        }

        .nav-btn.unlocked {
            background: #00e676; 
            color: #003300; 
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.6);
            animation: pulseBtn 1.5s infinite;
        }

        @keyframes pulseBtn {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* === RWD æ‰‹æ©Ÿç‰ˆé©é… === */
        @media (max-width: 768px) {
            .game-container { flex-direction: column; gap: 5px; }
            .status-panel { flex: 0 0 auto; width: 100%; flex-direction: row; flex-wrap: wrap; padding: 5px; gap: 5px; box-sizing: border-box; }
            .status-item { width: 45%; flex: 1 0 auto; padding: 3px; display: flex; align-items: center; justify-content: space-between; }
            .label { font-size: 12px; margin: 0; margin-right: 5px; }
            .progress-bg { width: 60px; height: 8px; }
            .rule-box { display: none; } 
            .center-stage { border-radius: 5px; }
            .event-section { flex: 0 0 70px; }
            .event-title { font-size: 22px; }
            .event-desc { font-size: 14px; }
            .body-outline { transform: scale(0.85); transform-origin: top center; margin-top: 10px; }
            .step-container { gap: 5px; }
            .arrow-icon { display: none; } 
            .step-box { width: 90px; padding: 5px; }
            .step-title { font-size: 14px; }
            .footer-nav { padding: 5px 10px; box-sizing: border-box; }
            .nav-btn { font-size: 16px; padding: 8px 15px; }
        }

        /* â˜…â˜…â˜… æ–°å¢ï¼šé‡å°ã€Œæ©«å¼ã€å¹³æ¿èˆ‡æ‰‹æ©Ÿçš„é«˜åº¦å„ªåŒ– â˜…â˜…â˜… */
        @media (max-height: 600px) {
            .overlay { 
                justify-content: flex-start; /* å…§å®¹éé•·æ™‚ï¼Œå¾é ‚éƒ¨é–‹å§‹æ’ï¼Œä¸è¦ç½®ä¸­ä»¥å…è¢«åˆ‡é ­ */
                padding-top: 20px;
            }
            .overlay h1 { font-size: 30px !important; margin: 0 0 5px 0 !important; } /* ç¸®å°å¤§æ¨™é¡Œ */
            .overlay p { font-size: 16px !important; margin: 0 !important; } /* ç¸®å°å‰¯æ¨™é¡Œ */
            .overlay div[style*="font-size:100px"] { font-size: 60px !important; margin: 5px 0 !important; } /* ç¸®å°åˆ†æ•¸ */
            
            /* è¡¨å–®ç·Šæ¹ŠåŒ– */
            .upload-form-container { margin-top: 5px; padding: 10px; max-width: 400px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .form-row { margin-bottom: 0; grid-column: span 1; }
            .form-row:last-of-type { grid-column: span 2; } /* å§“åæ¬„ä½è·¨å…©æ¬„ */
            #btnSubmit { grid-column: span 2; margin-top: 5px; }
            .btn-group { margin-top: 10px; }
        }
    </style>
</head>
<body>

    <div class="header-bar">
        <div class="score-val">SCORE: <span id="score-display">0</span></div>
        <div class="time-val">TIME: <span id="timer-display">60</span></div>
    </div>

    <div class="game-container">
        <div class="status-panel">
            <div class="status-item">
                <span class="label">è¡€ç³– Sugar</span>
                <div class="progress-bg"><div id="bar-sugar" class="progress-fill"></div></div>
            </div>
            <div class="status-item">
                <span class="label">å¿ƒè·³ Heart</span>
                <div class="progress-bg"><div id="bar-heart" class="progress-fill"></div></div>
            </div>
            <div class="status-item">
                <span class="label">è¡€éˆ£ Calcium</span>
                <div class="progress-bg"><div id="bar-calcium" class="progress-fill"></div></div>
            </div>
            <div class="status-item">
                <span class="label">ç”Ÿé•· Growth</span>
                <div class="progress-bg"><div id="bar-growth" class="progress-fill"></div></div>
            </div>
            <div class="rule-box">
                âš¡ <strong>é«˜æ‰‹è¦å‰‡ï¼š</strong><br>
                1. åªæœ‰ä¸€æ¬¡æ©Ÿæœƒ<br>
                2. ç­”éŒ¯ç›´æ¥ä¸‹ä¸€é¡Œ<br>
                3. <span style="color:#ff5252; font-weight:bold;">å¤±æ•—æ‰£ 500 åˆ†ï¼</span>
            </div>
        </div>

        <div class="center-stage">
            
            <div id="event-section" class="event-section">
                <h2 id="event-title" class="event-title">æº–å‚™...</h2>
                <p id="event-desc" class="event-desc">5ç§’é™æ™‚åå°„æŒ‘æˆ°</p>
                <div class="timer-bar-bg"><div id="timer-bar" class="timer-bar-fill"></div></div>
            </div>
            
            <div class="body-section">
                <div id="score-popup" class="score-popup">+1000</div>
                <div class="body-outline">
                    <div class="head"></div><div class="torso"></div><div class="arm-l"></div><div class="arm-r"></div><div class="leg-l"></div><div class="leg-r"></div>
                    <div id="btn-pituitary" class="gland-btn" onclick="selectGland('pituitary')">è…¦</div>
                    <div id="btn-thyroid" class="gland-btn" onclick="selectGland('thyroid')">ç”²</div>
                    <div id="btn-parathyroid" class="gland-btn" onclick="selectGland('parathyroid')">å‰¯</div>
                    <div id="btn-adrenal" class="gland-btn" onclick="selectGland('adrenal')">è…</div>
                    <div id="btn-pancreas" class="gland-btn" onclick="selectGland('pancreas')">èƒ°</div>
                </div>
            </div>

            <div id="control-panel" class="control-panel">
                <div id="placeholder" class="placeholder-text">ğŸ”´ è«‹å…ˆé»æ“Šéƒ¨ä½(åœ“é»)</div>
                <div id="action-buttons" style="display:none; width:100%; display:flex; gap:10px;"></div>
            </div>
        </div>
    </div>

    <div class="footer-nav">
        <a href="9.html" class="nav-btn">â† ä¸Šä¸€é </a>
        <a href="./11.html" id="btnNextPage" class="nav-btn disabled">ä¸‹ä¸€é  â†’</a>
    </div>

    <div id="overlay" class="overlay">
    </div>

    <script>
        // === ğŸ”´ Google Web App URL ===
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzEHcO9zHYEeyqXjrrY9L9z4v37LSv7M3l_2WXuHiDSD9YVnz91Obn7amIY_rLaXjBqdA/exec"; 
        
        let stats = { sugar: 50, heart: 50, calcium: 50, growth: 50 };
        let score = 0;
        // ä¿®æ­£ï¼šJS è®Šæ•¸é è¨­ 60
        let timeLeft = 60;
        let gameActive = false;
        let gameLoopTimer = null;
        let eventTimeoutTimer = null; 
        let processingTurn = false; 
        
        let currentEvent = null;
        let lastEventIndex = -1; 
        let eventStartTime = 0;
        let eventTimeLimit = 5000; 

        const eventsDB = [
            { id: 1, title: "ğŸ” åƒå¤§é¤ï¼", desc: "è¡€ç³–é£†å‡ (+40)", type: "sugar_high", target: "insulin", effect: {sugar: 40} },
            { id: 2, title: "ğŸ• è¢«ç‹—è¿½ï¼", desc: "èƒ½é‡è€—ç›¡ (-40)", type: "danger", target: "adrenaline", effect: {heart: -40, sugar: -20} },
            { id: 3, title: "ğŸ¥´ é¤“æ˜äº†ï¼", desc: "è¡€ç³–æš´è·Œ (-40)", type: "sugar_low", target: "glucagon", effect: {sugar: -40} },
            { id: 4, title: "âš¡ å¤§æŠ½ç­‹ï¼", desc: "è¡€éˆ£ä¸è¶³ (-40)", type: "cramp", target: "parathormone", effect: {calcium: -40} },
            { id: 5, title: "ğŸ“‰ å£“åŠ›å¤§ï¼", desc: "å¿ƒè·³é©Ÿé™ (-30)", type: "stress", target: "adrenaline", effect: {heart: -30, sugar: -10} },
            { id: 6, title: "ğŸŒ± é•·ä¸é«˜ï¼", desc: "ç”Ÿé•·åœæ»¯ (-30)", type: "growth", target: "growth", effect: {growth: -30} }
        ];

        window.onload = function() {
            showStartScreen();
        };

        function showStartScreen() {
            const overlay = document.getElementById("overlay");
            // ä¿®æ­£ï¼šæ–°å¢æç¤ºèªï¼Œä¸¦å°‡èªªæ˜æ–‡å­—æ”¹ç‚º 60 ç§’
            overlay.innerHTML = `
                <h1 style="font-size: 50px; color: #ffeb3b; margin:0 0 10px 0;">å…§åˆ†æ³Œå”èª¿é«˜æ‰‹</h1>
                <div class="step-container">
                    <div class="step-box">
                        <div class="step-icon">ğŸ‘€</div>
                        <div class="step-title">1.çœ‹é¡Œç›®</div>
                        <div class="step-desc">ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ</div>
                    </div>
                    <div class="arrow-icon">â¡</div>
                    <div class="step-box">
                        <div class="step-icon">ğŸ‘†</div>
                        <div class="step-title">2.é»å™¨å®˜</div>
                        <div class="step-desc">é»æ“Šå°æ‡‰åœ“é»</div>
                    </div>
                    <div class="arrow-icon">â¡</div>
                    <div class="step-box">
                        <div class="step-icon">ğŸ’Š</div>
                        <div class="step-title">3.é¸æ¿€ç´ </div>
                        <div class="step-desc">é¸æ“‡æ­£ç¢ºæ¿€ç´ </div>
                    </div>
                </div>
                <p style="font-size: 20px; color: #b0bec5;">60 ç§’æ¥µé€ŸæŒ‘æˆ°ãƒ»ç­”éŒ¯æ‰£ 500 åˆ†</p>
                <button class="start-btn" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
                <p style="margin-top: 15px; font-size: 18px; color: #81d4fa; font-weight: bold;">å¹³æ¿ã€æ‰‹æ©ŸéŠæˆ²ï¼Œè«‹ã€Œç›´å¼ã€å‘ˆç¾ç‚ºä½³</p>
            `;
            overlay.classList.remove("hidden");
        }

        function updateDisplay() {
            for (let key in stats) {
                let val = stats[key];
                if (val < 0) val = 0; if (val > 100) val = 100;
                stats[key] = val;
                
                let bar = document.getElementById(`bar-${key}`);
                bar.style.width = val + "%";
                if (val < 30 || val > 70) bar.style.background = "#ff1744"; 
                else bar.style.background = "#00e676";
            }
            document.getElementById("score-display").innerText = score;
            document.getElementById("timer-display").innerText = timeLeft;
        }

        function startGame() {
            stats = { sugar: 50, heart: 50, calcium: 50, growth: 50 };
            score = 0;
            // ä¿®æ­£ï¼šéŠæˆ²é–‹å§‹æ™‚è¨­å®šç‚º 60 ç§’
            timeLeft = 60; 
            gameActive = true;
            processingTurn = false;
            lastEventIndex = -1; 
            
            document.getElementById("overlay").classList.add("hidden");
            updateDisplay();

            clearInterval(gameLoopTimer);
            gameLoopTimer = setInterval(gameLoop, 1000);
            
            triggerNewEvent();
        }

        function gameLoop() {
            if (!gameActive) return;
            timeLeft--;
            if (timeLeft <= 0) { endGame(); return; }
            updateDisplay();
        }

        function triggerNewEvent() {
            if (!gameActive) return;
            
            processingTurn = false; 
            clearTimeout(eventTimeoutTimer);
            
            let timerBar = document.getElementById("timer-bar");
            timerBar.style.transition = "none";
            timerBar.style.width = "100%";
            void timerBar.offsetWidth; 
            
            let randIndex;
            do {
                randIndex = Math.floor(Math.random() * eventsDB.length);
            } while (randIndex === lastEventIndex && eventsDB.length > 1);
            
            lastEventIndex = randIndex; 
            currentEvent = eventsDB[randIndex];
            eventStartTime = Date.now();

            document.getElementById("event-title").innerText = currentEvent.title;
            document.getElementById("event-desc").innerText = currentEvent.desc;
            
            document.getElementById("placeholder").style.display = "block";
            document.getElementById("placeholder").innerText = "ğŸ”´ è«‹å…ˆé»æ“Šéƒ¨ä½(åœ“é»)";
            document.getElementById("action-buttons").style.display = "none";
            document.getElementById("action-buttons").innerHTML = ""; 

            for(let key in currentEvent.effect) {
                stats[key] += currentEvent.effect[key];
            }
            updateDisplay();

            setTimeout(() => {
                timerBar.style.transition = "width 5s linear";
                timerBar.style.width = "0%";
            }, 50);

            eventTimeoutTimer = setTimeout(() => {
                handleEventFail("é€¾æ™‚ï¼");
            }, eventTimeLimit);
        }

        function selectGland(gland) {
            if (!gameActive || processingTurn) return; 
            
            document.getElementById("placeholder").style.display = "none";
            let btnArea = document.getElementById("action-buttons");
            btnArea.style.display = "flex";
            btnArea.innerHTML = "";

            const makeBtn = (text, type, color) => 
                `<button class="hormone-btn ${color}" onclick="useHormone('${type}')">${text}</button>`;

            if (gland === 'pituitary') btnArea.innerHTML = makeBtn("ç”Ÿé•·æ¿€ç´ ", "growth", "blue");
            else if (gland === 'thyroid') btnArea.innerHTML = makeBtn("ç”²ç‹€è…ºç´ ", "thyroxine", "blue");
            else if (gland === 'parathyroid') btnArea.innerHTML = makeBtn("å‰¯ç”²ç‹€è…ºç´ ", "parathormone", "orange");
            else if (gland === 'adrenal') btnArea.innerHTML = makeBtn("è…ä¸Šè…ºç´ ", "adrenaline", "orange");
            else if (gland === 'pancreas') {
                btnArea.innerHTML = makeBtn("èƒ°å³¶ç´ (é™)", "insulin", "green") + makeBtn("å‡ç³–ç´ (å‡)", "glucagon", "orange");
            }
        }

        function useHormone(type) {
            if (!gameActive || processingTurn) return; 
            processingTurn = true; 
            
            clearTimeout(eventTimeoutTimer);

            if (currentEvent && type === currentEvent.target) {
                let reactionTime = (Date.now() - eventStartTime) / 1000;
                let points = Math.max(300, Math.floor(1000 - (reactionTime * 150))); 
                score += points;
                showScoreAnim(`+${points}`, true);
                
                fixStats(type); 
                setTimeout(triggerNewEvent, 200);

            } else {
                handleEventFail("ç­”éŒ¯ï¼");
            }
        }

        function handleEventFail(reason) {
            if (!gameActive) return;
            processingTurn = true; 
            
            score -= 500; 
            if(score < 0) score = 0;
            
            showScoreAnim(`-500 ${reason}`, false);
            fixStats(currentEvent.target); 
            
            setTimeout(triggerNewEvent, 500); 
        }

        function fixStats(type) {
            if (type === 'growth') stats.growth = 50; 
            if (type === 'thyroxine') { stats.heart = 50; stats.sugar = 50; }
            if (type === 'parathormone') stats.calcium = 50;
            if (type === 'adrenaline') { stats.heart = 50; stats.sugar = 50; }
            if (type === 'insulin') stats.sugar = 50;
            if (type === 'glucagon') stats.sugar = 50;
        }

        function showScoreAnim(text, isGood) {
            let popup = document.getElementById("score-popup");
            popup.innerText = text;
            popup.style.color = isGood ? "#ffeb3b" : "#ff1744"; 
            
            popup.classList.remove("score-anim");
            void popup.offsetWidth; 
            popup.classList.add("score-anim");
        }

        function endGame() {
            gameActive = false;
            clearInterval(gameLoopTimer);
            clearTimeout(eventTimeoutTimer);
            
            const overlay = document.getElementById("overlay");
            // â˜… å¼·åˆ¶æ²å‹•åˆ°é ‚éƒ¨ï¼Œé¿å…æ®˜ç•™çš„æ²å‹•ä½ç½®
            overlay.scrollTop = 0;

            overlay.innerHTML = `
                <h1 style="font-size:50px">æ™‚é–“åˆ°ï¼</h1>
                <p style="font-size:30px">æœ€çµ‚æˆç¸¾</p>
                <div style="font-size:100px;color:#ffeb3b;font-weight:bold">${score}</div>
                
                <div class="btn-group">
                    <button class="action-btn btn-restart" onclick="startGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
                    <button class="action-btn btn-upload" onclick="showUploadForm()">ğŸ“¤ ä¸Šå‚³æˆç¸¾</button>
                </div>

                <div id="uploadForm" class="upload-form-container">
                    <div class="form-row">
                        <label>ç­ç´š (Class)</label>
                        <input type="text" id="inputClass" placeholder="ä¾‹: 801">
                    </div>
                    <div class="form-row">
                        <label>åº§è™Ÿ (No.)</label>
                        <input type="number" id="inputSeat" placeholder="ä¾‹: 15">
                    </div>
                    <div class="form-row">
                        <label>å§“å (Name)</label>
                        <input type="text" id="inputName" placeholder="ä¾‹: ç‹å°æ˜">
                    </div>
                    <button id="btnSubmit" class="action-btn btn-submit" onclick="submitScore()">é€å‡ºè³‡æ–™</button>
                    <div id="uploadStatus" style="margin-top:10px; color:#cfd8dc;"></div>
                </div>
            `;
            overlay.classList.remove("hidden");
        }

        function showUploadForm() {
            const form = document.getElementById("uploadForm");
            form.style.display = "block"; // æˆ– gridï¼Œè¦– CSS è€Œå®š
            // è‹¥ç‚ºæ©«å¼ç•«é¢ï¼ŒCSS æœƒå°‡å…¶è®Šç‚º gridï¼Œé€™è£¡ä¸éœ€å¼·åˆ¶è¨­ç‚º blockï¼Œä½†ç‚ºäº† JS å…¼å®¹æ€§ï¼Œ
            // å»ºè­°é…åˆ CSSã€‚å¦‚æœ CSS è¨­ç‚º display:noneï¼Œé€™è£¡ç”¨ .style.display = 'grid' æˆ– 'block' 
            
            // åµæ¸¬æ˜¯å¦ç‚ºæ©«å¼çŸ­è¢å¹•ï¼Œè‡ªå‹•é©é…
            if (window.innerHeight < 600) {
                 form.style.display = "grid";
            } else {
                 form.style.display = "block";
            }

            document.querySelector(".btn-group").style.display = "none";
        }

        function submitScore() {
            const cls = document.getElementById("inputClass").value;
            const seat = document.getElementById("inputSeat").value;
            const name = document.getElementById("inputName").value;
            const btn = document.getElementById("btnSubmit");
            const status = document.getElementById("uploadStatus");

            if(!cls || !seat || !name) {
                alert("è«‹å°‡è³‡æ–™å¡«å¯«å®Œæ•´å–”ï¼");
                return;
            }

            btn.disabled = true;
            btn.classList.add("btn-disabled");
            btn.innerText = "ä¸Šå‚³ä¸­...";

            const data = {
                className: cls,
                seatNumber: seat,
                studentName: name,
                score: score
            };

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(() => {
                btn.innerText = "å·²é€å‡º";

                const nextBtn = document.getElementById("btnNextPage");
                if(nextBtn) {
                    nextBtn.classList.remove("disabled");
                    nextBtn.classList.add("unlocked");
                    nextBtn.innerText = "ä¸‹ä¸€é  â†’ (GO!)";
                }

                status.innerHTML = `
                    <br>
                    <div id="successMsg" style="color:#69f0ae; font-size:20px; font-weight:bold; margin-bottom:15px;">âœ… ä¸Šå‚³æˆåŠŸï¼</div>
                    <a href="./11.html" id="finalNextBtn" style="
                        display:block; width:100%; padding:15px; 
                        background:#ffeb3b; color:#333; 
                        text-decoration:none; border-radius:10px; 
                        font-weight:bold; font-size:22px; 
                        text-align:center; box-sizing:border-box;
                        box-shadow: 0 4px 15px rgba(255, 235, 59, 0.4);">
                        å‰å¾€ä¸‹ä¸€é  â¡
                    </a>
                `;
                
                btn.style.display = 'none';

                // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šç¢ºä¿æŒ‰éˆ•å‡ºç¾åœ¨è¦–é‡ä¸­ â˜…â˜…â˜…
                // æœ‰æ™‚å€™éµç›¤å½ˆå‡ºæœƒæŠŠç•«é¢é ‚ä¸Šå»ï¼Œæ‰€ä»¥è¦ç¢ºä¿é€™å€‹å€åŸŸè¢«æ²å‹•åˆ°å¯è¦‹ç¯„åœ
                setTimeout(() => {
                    status.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);

            }).catch(err => {
                console.error(err);
                status.innerText = "âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
                btn.disabled = false;
                btn.classList.remove("btn-disabled");
                btn.innerText = "é€å‡ºè³‡æ–™";
            });
        }
    </script>
</body>
</html>